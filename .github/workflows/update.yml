name: Update Leaderboard

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger button
  push:
    branches: [main]

# ============================================
# CONFIGURATION - EDIT THESE DATES
# ============================================
env:
  COMPETITION_START: "2025-12-18"
  COMPETITION_END: "2026-01-18"
  API_URL: "https://api.torn.com/v2/faction/contributors?stat=gymenergy&cat=current&comment=Olu"
# ============================================

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Fetch Data and Build Page
        env:
          API_KEY: ${{ secrets.TORN_API_KEY }}
        run: |
          set -e  # Exit on any error
          
          echo "================================================"
          echo "Starting leaderboard update"
          echo "================================================"
          echo "Competition Start: $COMPETITION_START"
          echo "Competition End: $COMPETITION_END"
          echo "Current Time: $(date -u)"
          echo ""
          
          # Check if API key exists
          if [ -z "$API_KEY" ]; then
            echo "ERROR: TORN_API_KEY secret is not set!"
            exit 1
          fi
          echo "‚úì API key found"
          
          # Check if competition has ended
          TODAY=$(date +%Y-%m-%d)
          echo "Today's date: $TODAY"
          
          if [[ "$TODAY" > "$COMPETITION_END" ]]; then
            echo "‚ö†Ô∏è  Competition has ended. Skipping data fetch."
            STATUS="üèÅ Competition Ended"
            STATUS_COLOR="rgba(255,71,87,0.8)"
            SKIP_FETCH=true
          else
            echo "‚úì Competition is active"
            STATUS="üî• Competition Active"
            STATUS_COLOR="rgba(39,174,96,0.8)"
            SKIP_FETCH=false
          fi
          echo ""
          
          # Fetch current data from API
          if [ "$SKIP_FETCH" = false ]; then
            echo "Fetching current data from Torn API..."
            HTTP_CODE=$(curl -s -w "%{http_code}" -o current.json "${API_URL}&key=${API_KEY}")
            
            if [ "$HTTP_CODE" != "200" ]; then
              echo "ERROR: API request failed with HTTP code $HTTP_CODE"
              if [ -f current.json ]; then
                cat current.json
              fi
              exit 1
            fi
            echo "‚úì API request successful (HTTP $HTTP_CODE)"
            
            if ! jq empty current.json 2>/dev/null; then
              echo "ERROR: Invalid JSON response"
              cat current.json
              exit 1
            fi
            echo "‚úì Valid JSON received"
          else
            if [ ! -f current.json ]; then
              echo "ERROR: Competition ended but no current.json found"
              exit 1
            fi
            echo "Using existing current.json"
          fi
          
          # Check if baseline exists, if not create it
          if [ ! -f baseline.json ]; then
            echo ""
            echo "================================================"
            echo "‚ö†Ô∏è  NO BASELINE FOUND - CREATING INITIAL SNAPSHOT"
            echo "================================================"
            echo "This will be your starting point for the competition."
            echo "All progress will be measured from these values."
            echo ""
            
            cp current.json baseline.json
            
            echo "Baseline created with $(jq '.contributors | length' baseline.json) contributors:"
            jq -r '.contributors | sort_by(-.value) | .[:5][] | "  \(.username): \(.value)"' baseline.json
            echo ""
            echo "‚ö†Ô∏è  If these values look wrong, delete baseline.json and run again"
            echo "================================================"
          else
            echo "‚úì Baseline found"
          fi
          
          # Calculate differences
          echo ""
          echo "Calculating progress (current - baseline)..."
          
          jq -n '
            ($baseline[0].contributors | INDEX(.[]; .id)) as $base |
            ($current[0].contributors | INDEX(.[]; .id)) as $curr |
            
            [
              $curr | to_entries[] | 
              {
                id: (.value.id),
                username: (.value.username),
                baseline: (($base[.key] // {value: 0}).value),
                current: (.value.value),
                progress: ((.value.value) - (($base[.key] // {value: 0}).value)),
                in_faction: (.value.in_faction)
              }
            ] | sort_by(-.progress)
          ' \
            --slurpfile baseline baseline.json \
            --slurpfile current current.json > progress.json
          
          TOTAL_CONTRIBUTORS=$(jq 'length' progress.json)
          ACTIVE_CONTRIBUTORS=$(jq '[.[] | select(.progress > 0)] | length' progress.json)
          echo "‚úì Calculated progress for $TOTAL_CONTRIBUTORS contributors"
          echo "‚úì $ACTIVE_CONTRIBUTORS have positive progress"
          
          # Generate HTML page
          echo ""
          echo "Building HTML page..."
          
          cat > index.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Gym Energy Leaderboard</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
              }
              .container { max-width: 1000px; margin: 0 auto; }
              .header {
                text-align: center;
                color: white;
                margin-bottom: 30px;
              }
              .header h1 { font-size: 2.5em; margin-bottom: 10px; }
              .header p { font-size: 1.1em; opacity: 0.9; margin-top: 5px; }
              .status {
                background: STATUS_COLOR_PLACEHOLDER;
                padding: 10px 20px;
                border-radius: 20px;
                display: inline-block;
                margin-top: 10px;
                font-weight: bold;
              }
              .competition-dates {
                color: rgba(255,255,255,0.9);
                margin-top: 10px;
                font-size: 0.9em;
              }
              .podium {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
              }
              .podium-item {
                background: white;
                border-radius: 15px;
                padding: 25px;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                transition: transform 0.3s;
              }
              .podium-item:hover { transform: translateY(-5px); }
              .podium-item:first-child {
                background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
              }
              .rank { font-size: 3em; margin-bottom: 10px; }
              .username { font-size: 1.4em; font-weight: bold; margin-bottom: 5px; }
              .energy { font-size: 1.8em; color: #667eea; font-weight: bold; margin-top: 5px; }
              .podium-item:first-child .energy { color: #fff; }
              .baseline { font-size: 0.85em; color: #666; margin-top: 5px; }
              .podium-item:first-child .baseline { color: rgba(255,255,255,0.8); }
              .table-container {
                background: white;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                overflow-x: auto;
              }
              table { width: 100%; border-collapse: collapse; }
              th, td { padding: 15px 12px; text-align: left; border-bottom: 1px solid #eee; }
              th { background: #f8f9fa; font-weight: bold; color: #667eea; position: sticky; top: 0; }
              tr:hover { background: #f8f9fa; }
              .rank-col { width: 80px; text-align: center; font-weight: bold; font-size: 1.1em; }
              .number-col { text-align: right; font-weight: bold; }
              .progress-col { color: #27ae60; }
              .baseline-col { color: #95a5a6; font-size: 0.9em; }
              .updated { 
                text-align: center; 
                color: white; 
                margin-top: 20px; 
                font-size: 0.9em;
                background: rgba(0,0,0,0.2);
                padding: 10px;
                border-radius: 10px;
              }
              .zero-progress { opacity: 0.5; }
              @media (max-width: 768px) {
                .header h1 { font-size: 1.8em; }
                .podium { grid-template-columns: 1fr; }
                th, td { padding: 10px 5px; font-size: 0.85em; }
                .rank { font-size: 2em; }
                .username { font-size: 1.1em; }
                .energy { font-size: 1.3em; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="header">
                <h1>üèãÔ∏è Gym Energy Competition</h1>
                <p>Tracking progress from competition start</p>
                <div class="status">STATUS_PLACEHOLDER</div>
                <div class="competition-dates">DATES_PLACEHOLDER</div>
              </div>
              
              <div class="podium">
          PODIUM_PLACEHOLDER
              </div>
              
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th class="rank-col">Rank</th>
                      <th>Username</th>
                      <th class="number-col">Progress</th>
                      <th class="number-col">Baseline</th>
                      <th class="number-col">Current</th>
                    </tr>
                  </thead>
                  <tbody>
          TABLE_PLACEHOLDER
                  </tbody>
                </table>
              </div>
              
              <div class="updated">
                Last updated: TIMESTAMP_PLACEHOLDER<br>
                Next update: NEXT_UPDATE_PLACEHOLDER
              </div>
            </div>
          </body>
          </html>
          HTMLEOF
          
          echo "‚úì HTML template created"
          
          # Build HTML from progress data
          echo "Processing leaderboard data..."
          PODIUM=""
          TABLE=""
          RANK=1
          MEDALS=("ü•á" "ü•à" "ü•â")
          
          while IFS= read -r row; do
            USERNAME=$(echo "$row" | jq -r '.username')
            PROGRESS=$(echo "$row" | jq -r '.progress')
            BASELINE=$(echo "$row" | jq -r '.baseline')
            CURRENT=$(echo "$row" | jq -r '.current')
            
            if [ -z "$USERNAME" ] || [ "$USERNAME" = "null" ]; then
              continue
            fi
            
            # Format numbers
            PROGRESS_FMT=$(printf "%'d" $PROGRESS 2>/dev/null || echo $PROGRESS)
            BASELINE_FMT=$(printf "%'d" $BASELINE 2>/dev/null || echo $BASELINE)
            CURRENT_FMT=$(printf "%'d" $CURRENT 2>/dev/null || echo $CURRENT)
            
            # Add to podium (top 3 with progress > 0)
            if [ $RANK -le 3 ] && [ "$PROGRESS" -gt 0 ]; then
              MEDAL="${MEDALS[$RANK-1]}"
              PODIUM+="<div class=\"podium-item\">"
              PODIUM+="<div class=\"rank\">$MEDAL</div>"
              PODIUM+="<div class=\"username\">$USERNAME</div>"
              PODIUM+="<div class=\"energy\">+$PROGRESS_FMT</div>"
              PODIUM+="<div class=\"baseline\">Started at: $BASELINE_FMT</div>"
              PODIUM+="</div>"
            fi
            
            # Add to table
            if [ "$PROGRESS" -eq 0 ]; then
              TABLE+="<tr class=\"zero-progress\">"
            else
              TABLE+="<tr>"
            fi
            TABLE+="<td class=\"rank-col\">$RANK</td>"
            TABLE+="<td>$USERNAME</td>"
            TABLE+="<td class=\"number-col progress-col\">+$PROGRESS_FMT</td>"
            TABLE+="<td class=\"number-col baseline-col\">$BASELINE_FMT</td>"
            TABLE+="<td class=\"number-col\">$CURRENT_FMT</td>"
            TABLE+="</tr>"
            
            RANK=$((RANK + 1))
          done < <(jq -c '.[]' progress.json)
          
          echo "‚úì Processed $((RANK - 1)) contributors"
          
          if [ -z "$PODIUM" ]; then
            PODIUM="<div class=\"podium-item\"><div class=\"username\">No progress yet</div></div>"
          fi
          
          if [ -z "$TABLE" ]; then
            TABLE="<tr><td colspan=\"5\" style=\"text-align:center;\">No data</td></tr>"
          fi
          
          # Replace placeholders
          NEXT_UPDATE=$(date -u -d "+6 hours" "+%Y-%m-%d %H:%M UTC" 2>/dev/null || echo "In 6 hours")
          TIMESTAMP=$(date -u "+%Y-%m-%d %H:%M:%S UTC")
          DATES="$COMPETITION_START to $COMPETITION_END"
          
          sed -i "s|STATUS_PLACEHOLDER|$STATUS|g" index.html
          sed -i "s|STATUS_COLOR_PLACEHOLDER|$STATUS_COLOR|g" index.html
          sed -i "s|DATES_PLACEHOLDER|$DATES|g" index.html
          sed -i "s|PODIUM_PLACEHOLDER|$PODIUM|g" index.html
          sed -i "s|TABLE_PLACEHOLDER|$TABLE|g" index.html
          sed -i "s|TIMESTAMP_PLACEHOLDER|$TIMESTAMP|g" index.html
          sed -i "s|NEXT_UPDATE_PLACEHOLDER|$NEXT_UPDATE|g" index.html
          
          echo "‚úì HTML page built successfully"
          echo ""
          echo "Preview of top 3 progress:"
          jq -r '.[:3][] | "  \(.username): +\(.progress) (was \(.baseline), now \(.current))"' progress.json || echo "  (none)"
          
      - name: Commit and Push Changes
        run: |
          echo ""
          echo "================================================"
          echo "Deploying to GitHub Pages"
          echo "================================================"
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add index.html baseline.json current.json progress.json
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git commit -m "Update leaderboard - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "‚úì Changes pushed successfully"
          fi
          
          echo ""
          echo "================================================"
          echo "Update complete!"
          echo "================================================"
